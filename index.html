<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel RT Modern</title>
    
    <!-- Font Inter (Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --fb-blue: #1877f2;
            --bg-body: #f0f2f5;
            --surface: #ffffff;
            --text-main: #050505;
            --text-muted: #65676b;
            --border-color: #ced0d4;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-float: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            padding-bottom: 90px; /* Space for bottom nav */
        }

        /* --- NAVBAR --- */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding-top: 0.8rem;
            padding-bottom: 0.8rem;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--text-main) !important;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .navbar-brand i {
            color: #6366f1;
        }

        /* --- CONTENT WRAPPER --- */
        .content-wrapper {
            background: transparent;
            box-shadow: none;
            padding: 0;
            margin-top: 20px;
        }

        /* --- BOTTOM FACEBOOK-STYLE NAV --- */
        .bottom-nav-wrapper {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            padding: 6px;
            border-radius: 50px;
            box-shadow: var(--shadow-float);
            display: flex;
            width: 90%;
            max-width: 420px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .nav-tabs.bottom-tabs {
            border: none;
            background: transparent;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0;
            margin: 0;
            gap: 4px;
        }

        .nav-tabs.bottom-tabs .nav-item {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .nav-tabs.bottom-tabs .nav-link {
            color: var(--text-muted);
            font-weight: 600;
            border: none;
            border-radius: 40px;
            padding: 8px 4px; /* Compact padding */
            transition: all 0.3s ease;
            font-size: 0.8rem;
            white-space: nowrap;
            text-align: center;
        }
        .nav-tabs.bottom-tabs .nav-link.active {
            background-color: var(--fb-blue);
            color: white;
            box-shadow: 0 2px 5px rgba(24, 119, 242, 0.4);
        }
        .nav-tabs.bottom-tabs .nav-link:hover:not(.active) {
            background-color: #f0f2f5;
            color: var(--text-main);
        }

        /* --- BUTTONS --- */
        .btn-primary-custom {
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .btn-primary-custom:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
            color: white;
        }
        .btn-primary-custom:active {
            transform: translateY(1px);
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* --- LOADER --- */
        .loader {
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
        }

        /* --- ALERT --- */
        .alert {
            border: none;
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-md);
        }
        
        /* --- UANG KAS CARDS --- */
        .uangkas-control-bar {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border:1px solid var(--border-color);
        }
        .uangkas-balance-display {
            text-align: right;
        }
        .uangkas-balance-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .uangkas-balance-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .uangkas-period-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border:1px solid var(--border-color);
        }
        .uangkas-period-header {
            background-color: #f9fafb;
            padding: 16px 20px;
            font-weight: 600;
            color: var(--text-main);
            border-bottom:1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; 
            transition: background 0.2s;
        }
        .uangkas-period-header:hover {
            background-color: #f3f4f6;
        }
        .uangkas-period-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }
        .uangkas-period-icon {
            width: 32px;
            height: 32px;
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .uangkas-period-saldo {
            font-weight: 700;
            color: var(--success-color);
            font-size: 0.95rem;
            background: #ecfdf5;
            padding: 4px 12px;
            border-radius: 20px;
        }
        .chevron-icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-muted);
        }
        .uangkas-period-header:not(.collapsed) .chevron-icon {
            transform: rotate(180deg);
        }

        /* --- TABLES & STICKY COLS --- */
        .table-responsive {
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
            position: relative; /* Needed for sticky context */
        }
        .table {
            margin-bottom: 0;
            color: var(--text-main);
            font-size: 0.9rem;
        }
        .table thead th {
            background-color: #f9fafb;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .table tbody tr {
            transition: background 0.1s;
        }
        .table tbody tr:hover {
            background-color: #f9fafb;
        }
        .table td {
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Sticky First Column Logic */
        .table th:first-child,
        .table td:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: var(--surface); /* Must match body bg */
            border-right: 1px solid #f3f4f6;
        }
        /* Higher Z-Index for Header Sticky */
        .table thead th:first-child {
            z-index: 20;
            background-color: #f9fafb; /* Match thead bg */
            border-right: 1px solid #e5e7eb;
        }
        
        /* Action Buttons in Table */
        .action-cell .btn {
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        /* --- MODAL --- */
        .modal-content {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            border-bottom:1px solid var(--border-color);
            padding: 20px 24px;
        }
        .modal-title {
            font-weight: 700;
            color: var(--text-main);
        }
        .modal-body {
            padding: 24px;
        }
        .modal-footer {
            border-top:1px solid var(--border-color);
            padding: 16px 24px;
            background: #f9fafb;
            border-bottom-left-radius: var(--radius-lg);
            border-bottom-right-radius: var(--radius-lg);
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 10px 14px;
            font-size: 0.95rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .form-label {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 6px;
            color: var(--text-main);
        }

        /* --- ICONS & CLICKABLE --- */
        .clickable-icon {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .clickable-icon:active {
            transform: scale(0.9);
        }

        /* --- MOBILE OPTIMIZATIONS (< 768px) --- */
        @media (max-width: 768px) {
            body {
                padding-bottom: 85px; /* Slightly less padding for bottom nav */
            }
            .content-wrapper {
                margin-top: 10px;
                padding: 0 8px; /* Less padding */
            }

            /* Bottom Nav Mobile Tweak */
            .bottom-nav-wrapper {
                width: 95%;
                padding: 5px;
            }
            .nav-tabs.bottom-tabs .nav-link {
                font-size: 0.75rem;
                padding: 6px 2px;
            }

            /* Control Bar Stacking */
            .uangkas-control-bar {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
                text-align: center;
                padding: 12px;
            }
            .uangkas-balance-display {
                text-align: center;
                background: white;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid #e5e7eb;
            }
            .uangkas-balance-amount {
                font-size: 1.1rem;
            }
            
            /* Card Header Mobile */
            .uangkas-period-header {
                flex-direction: row; 
                padding: 10px 12px;
            }
            .uangkas-period-title {
                font-size: 0.85rem;
            }
            .uangkas-period-saldo {
                font-size: 0.75rem;
                padding: 2px 8px;
                display: none; /* Hide saldo per month on small mobile to save space */
            }
            /* Show saldo only on hover or if expanded */
            .uangkas-period-header:hover .uangkas-period-saldo {
                display: block;
                position: absolute;
                top: -10px;
                right: 10px;
                background: #10b981;
                color: white;
                z-index: 5;
            }

            /* ULTRA COMPACT TABLES (Requested) */
            .table {
                font-size: 0.7rem !important; /* Very small */
            }
            .table th, .table td {
                padding: 4px 6px !important; /* Tighter padding */
            }
            
            /* Hide text in small buttons, keep icons */
            .btn-sm span {
                display: none;
            }
            .btn-sm i {
                margin: 0;
                font-size: 1rem;
            }
            
            /* Adjust sticky column width slightly */
            .table th:first-child, .table td:first-child {
                min-width: 100px;
            }
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader" class="loader" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-light">
        <div class="container-fluid px-3 px-md-5">
            <span class="navbar-brand">
                <i class="bi bi-grid-1x2-fill"></i>
                <span>Admin Panel RT</span>
            </span>
            <div class="d-flex align-items-center">
                <!-- Optional: Current Sheet Indicator if needed, removing to save space for bottom nav -->
            </div>
        </div>
    </nav>

    <!-- Alert Container -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- Main Content -->
    <main class="container">
        <div class="content-wrapper">
            <!-- Konten Tab -->
            <div class="tab-content" id="sheetTabContent">
                
                <!-- Header Tombol Tambah (Standard) -->
                <div class="d-flex justify-content-between align-items-center mb-4 px-1" id="actionHeader">
                    <h2 class="h4 fw-bold text-dark">Data Tabel</h2>
                    <button class="btn btn-primary-custom btn-sm" onclick="openCreateModal()">
                        <i class="bi bi-plus-lg me-1"></i> Tambah Data
                    </button>
                </div>

                <!-- Wadah untuk Tabel Biasa -->
                <div class="table-responsive d-none p-0" id="standardTableContainer" style="background: white; border-radius: 12px; box-shadow: var(--shadow-sm);">
                    <table class="table table-hover align-middle" id="dataTable">
                        <thead>
                            <!-- Header akan di-generate oleh JavaScript -->
                        </thead>
                        <tbody>
                            <!-- Baris data akan di-generate oleh JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Wadah untuk Uang Kas (Grouped Tables) -->
                <div id="uangKasContainer"></div>

            </div>
        </div>
    </main>

    <!-- BOTTOM FACEBOOK STYLE NAV -->
    <div class="bottom-nav-wrapper">
        <ul class="nav nav-tabs bottom-tabs" id="sheetTabs" role="tablist">
            <!-- Tab akan di-generate oleh JavaScript -->
        </ul>
    </div>

    <!-- Modal Create/Update -->
    <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="formModalLabel">Tambah Data Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="dataForm">
                    <div class="modal-body" id="formModalBody">
                        <!-- Input form akan di-generate oleh JavaScript -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light fw-semibold" data-bs-dismiss="modal" style="border: 1px solid #d1d5db;">Batal</button>
                        <button type="submit" class="btn btn-primary-custom">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Delete Confirmation -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-danger" id="deleteModalLabel">Hapus Data?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-secondary">Data yang dihapus tidak dapat dikembalikan.</p>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light w-100 fw-semibold" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger w-100" id="confirmDeleteBtn">
                        <i class="bi bi-trash"></i> Hapus
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- KONFIGURASI ---
        const SHEETS = ['PENGUMUMAN', 'UANG KAS', 'IURAN BULANAN', 'JADWAL RONDA']; 
        const API_URL = 'https://script.google.com/macros/s/AKfycbz3jfwGsX6_2pTpStnVVnEnTwWwQgEqYpjUZPsP36_dTGZjzg1hyfQTFvxp89C2PGsh/exec';
        
        // Sheet yang menggunakan ikon boolean
        const BOOLEAN_SHEETS = ['IURAN BULANAN', 'JADWAL RONDA'];

        let currentHeaders = [];
        let currentAction = 'create';
        let currentRowNumber = null;
        let currentSheet = SHEETS[0];
        let tableData = []; 

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTabs();
            loadData(currentSheet);
            
            document.getElementById('dataForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
        });

        // --- INISIALISASI TAB ---
        function initializeTabs() {
            const tabList = document.getElementById('sheetTabs');
            SHEETS.forEach((sheetName, index) => {
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.setAttribute('role', 'presentation');

                const button = document.createElement('button');
                button.className = `nav-link ${index === 0 ? 'active' : ''}`;
                button.setAttribute('type', 'button');
                button.setAttribute('role', 'tab');
                button.textContent = sheetName;
                button.onclick = () => switchSheet(sheetName, button);

                li.appendChild(button);
                tabList.appendChild(li);
            });
        }

        function switchSheet(sheetName, buttonElement) {
            document.querySelectorAll('#sheetTabs .nav-link').forEach(btn => btn.classList.remove('active'));
            buttonElement.classList.add('active');
            currentSheet = sheetName;
            
            loadData(currentSheet);
        }

        // --- FUNGSI UTILITAS TANGGAL ---
        function formatDateDisplay(value) {
            if (!value) return '';
            
            if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
                return value;
            }

            let dateObj;
            if (typeof value === 'string') {
                dateObj = new Date(value);
            } else if (value instanceof Date) {
                dateObj = value;
            } else {
                return value; 
            }

            if (isNaN(dateObj.getTime())) return value; 

            return dateObj.toLocaleDateString('en-CA'); 
        }

        // --- FUNGSI-FUNGSI UTAMA ---

        async function loadData(sheetName) {
            showLoader(true);
            try {
                const response = await fetch(`${API_URL}?sheet=${sheetName}`);
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                currentHeaders = result.headers;
                tableData = result.rows;
                renderTable(result.headers, result.rows);
                
            } catch (error) {
                showAlert('Gagal memuat data: ' + error.message, 'danger');
                document.querySelector('#dataTable thead').innerHTML = '';
                document.querySelector('#dataTable tbody').innerHTML = '';
                document.getElementById('uangKasContainer').innerHTML = '';
            } finally {
                showLoader(false);
            }
        }

        function renderTable(headers, rows) {
            const standardContainer = document.getElementById('standardTableContainer');
            const uangKasContainer = document.getElementById('uangKasContainer');
            const actionHeader = document.getElementById('actionHeader');
            
            standardContainer.classList.add('d-none');
            uangKasContainer.innerHTML = '';
            
            if (currentSheet === 'UANG KAS') {
                actionHeader.classList.add('d-none');
            } else {
                actionHeader.classList.remove('d-none');
            }

            if (currentSheet === 'UANG KAS') {
                renderUangKasGrouped(headers, rows, uangKasContainer);
                return;
            }

            standardContainer.classList.remove('d-none');
            const table = document.getElementById('dataTable');
            const tableHead = table.querySelector('thead');
            const tableBody = table.querySelector('tbody');
            
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            if (headers.length === 0) {
                renderEmptyState(tableBody);
                return;
            }

            let dataKeys = headers; 
            let displayHeaders = headers; 

            if (currentSheet === 'JADWAL RONDA') {
                const firstHeader = headers[0];
                let selectedColumns = [firstHeader];
                const lastRondaIndex = headers.findIndex(h => String(h).toLowerCase() === "terakhir ronda");
                const searchLimit = (lastRondaIndex > 0) ? lastRondaIndex : headers.length - 1;
                
                let trueColumns = [];
                for (let i = searchLimit - 1; i >= 1 && trueColumns.length < 8; i--) {
                    const columnName = headers[i];
                    const hasTrueValue = rows.some(row => row[columnName] === true);
                    if (hasTrueValue) {
                        trueColumns.unshift(columnName);
                    }
                }
                selectedColumns.push(...trueColumns);
                let lastTrueColumnIndex = 0;
                if (trueColumns.length > 0) {
                    lastTrueColumnIndex = headers.indexOf(trueColumns[trueColumns.length - 1]);
                }
                for (let i = 1; i <= 2; i++) {
                    const nextColumnIndex = lastTrueColumnIndex + i;
                    if (nextColumnIndex > 0 && nextColumnIndex < headers.length && nextColumnIndex !== lastRondaIndex) {
                        selectedColumns.push(headers[nextColumnIndex]);
                    }
                }
                if (lastRondaIndex !== -1 && !selectedColumns.includes(headers[lastRondaIndex])) {
                    selectedColumns.push(headers[lastRondaIndex]);
                }
                dataKeys = selectedColumns;
                displayHeaders = dataKeys.map(h => String(h).replace(/-\d{4}$/, ''));
            }

            const headerRow = document.createElement('tr');
            displayHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            const thAction = document.createElement('th');
            thAction.textContent = 'Aksi';
            thAction.className = 'text-end pe-3';
            headerRow.appendChild(thAction);
            tableHead.appendChild(headerRow);

            rows.forEach(row => {
                const tr = document.createElement('tr');
                dataKeys.forEach(dataKey => {
                    const td = document.createElement('td');
                    const cellValue = row[dataKey];
                    if (BOOLEAN_SHEETS.includes(currentSheet) && typeof cellValue === 'boolean') {
                        td.className = 'text-center';
                        const icon = document.createElement('i');
                        icon.className = 'clickable-icon bi ';
                        if (cellValue) {
                            icon.className += 'bi-check-circle-fill text-success fs-5';
                            icon.title = 'Selesai. Klik untuk ubah.';
                        } else {
                            icon.className += 'bi-circle text-muted fs-5';
                            icon.title = 'Belum Selesai. Klik untuk ubah.';
                        }
                        icon.onclick = () => toggleBoolean(row._row, dataKey, icon);
                        td.appendChild(icon);
                    } else {
                        td.textContent = cellValue || '-';
                    }
                    tr.appendChild(td);
                });
                
                const tdAction = document.createElement('td');
                tdAction.className = 'text-end pe-3';
                let actionButtonsHTML = '';
                if (BOOLEAN_SHEETS.includes(currentSheet)) {
                    actionButtonsHTML = `<button class="btn btn-danger btn-sm rounded-circle" style="width:32px; height:32px; padding:0; display:inline-flex; align-items:center; justify-content:center;" onclick="openDeleteModal(${row._row})"><i class="bi bi-trash"></i></button>`;
                } else {
                    actionButtonsHTML = `
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-warning btn-sm" onclick="openUpdateModal(${row._row}, ${JSON.stringify(row).replace(/"/g, '&quot;')})">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="openDeleteModal(${row._row})">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    `;
                }
                tdAction.innerHTML = actionButtonsHTML;
                tr.appendChild(tdAction);
                tableBody.appendChild(tr);
            });

            // LOGIKA SCROLL KE KANAN UNTUK JADWAL RONDA (MOBILE)
            if (currentSheet === 'JADWAL RONDA' && window.innerWidth <= 768) {
                setTimeout(() => {
                    if (standardContainer.scrollWidth > standardContainer.clientWidth) {
                        standardContainer.scrollLeft = standardContainer.scrollWidth;
                    }
                }, 100);
            }
        }

        // --- FUNGSI KHUSUS RENDER UANG KAS (GROUPED & COLLAPSIBLE) ---
        function renderUangKasGrouped(headers, rows, container) {
            let grandTotal = 0;
            const keyMasuk = headers.find(h => h.toLowerCase().includes('pemasukkan')) || headers[4];
            const keyKeluar = headers.find(h => h.toLowerCase().includes('pengeluaran')) || headers[5];

            rows.forEach(r => {
                const masuk = parseFloat(r[keyMasuk]) || 0;
                const keluar = parseFloat(r[keyKeluar]) || 0;
                grandTotal += (masuk - keluar);
            });

            const controlBar = document.createElement('div');
            controlBar.className = 'uangkas-control-bar';
            
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-primary-custom';
            addBtn.innerHTML = '<i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">Tambah Transaksi</span>';
            addBtn.onclick = openCreateModal;
            
            const totalDiv = document.createElement('div');
            totalDiv.className = 'uangkas-balance-display';
            totalDiv.innerHTML = `
                <div class="uangkas-balance-label">Saldo Kas Saat Ini</div>
                <div class="uangkas-balance-amount">Rp ${grandTotal.toLocaleString('id-ID')}</div>
            `;

            controlBar.appendChild(addBtn);
            controlBar.appendChild(totalDiv);
            container.appendChild(controlBar);

            if (rows.length === 0) {
                container.innerHTML += '<div class="text-center py-5"><div class="mb-3 text-muted"><i class="bi bi-wallet2" style="font-size: 3rem; opacity: 0.3;"></i></div><p class="text-muted">Belum ada data kas.</p></div>';
                return;
            }

            const keyPeriode = headers.find(h => h.toLowerCase() === 'periode') || headers[1];
            const keyTanggal = headers.find(h => h.toLowerCase() === 'tanggal') || headers[2];
            const keyKet = headers.find(h => h.toLowerCase().includes('keterangan')) || headers[3];

            const formatPeriodeDisplay = (rawVal) => {
                if (!rawVal) return 'Tanpa Periode';
                
                if (typeof rawVal === 'string' && !rawVal.includes('T') && isNaN(new Date(rawVal).getTime())) {
                    return rawVal;
                }

                const dateObj = new Date(rawVal);
                if (isNaN(dateObj.getTime())) return String(rawVal);

                return dateObj.toLocaleDateString('id-ID', { month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' });
            };

            const groups = rows.reduce((acc, row) => {
                const rawPeriode = row[keyPeriode];
                const displayPeriode = formatPeriodeDisplay(rawPeriode);
                const refDate = row[keyTanggal] ? new Date(row[keyTanggal]) : new Date(0);

                if (!acc[displayPeriode]) {
                    acc[displayPeriode] = {
                        rows: [],
                        sortDate: refDate
                    };
                }
                acc[displayPeriode].rows.push(row);
                if (refDate > acc[displayPeriode].sortDate) {
                    acc[displayPeriode].sortDate = refDate;
                }
                return acc;
            }, {});

            const sortedPeriodKeys = Object.keys(groups).sort((a, b) => {
                return groups[b].sortDate - groups[a].sortDate;
            });

            sortedPeriodKeys.forEach((periode, index) => {
                const groupData = groups[periode];
                const groupRows = groupData.rows;
                let totalMasuk = 0;
                let totalKeluar = 0;
                
                groupRows.sort((a, b) => {
                    const dateA = a[keyTanggal] ? new Date(a[keyTanggal]) : new Date(0);
                    const dateB = b[keyTanggal] ? new Date(b[keyTanggal]) : new Date(0);
                    return dateB - dateA;
                });

                const collapseId = `collapse-${periode.replace(/\s+/g, '-')}`;
                const isTopCard = (index === 0);
                const headerCollapsedClass = isTopCard ? '' : 'collapsed';
                const bodyShowClass = isTopCard ? 'show' : '';
                const ariaExpanded = isTopCard ? 'true' : 'false';

                const card = document.createElement('div');
                card.className = 'uangkas-period-card';

                groupRows.forEach(r => {
                    const masuk = parseFloat(r[keyMasuk]) || 0;
                    const keluar = parseFloat(r[keyKeluar]) || 0;
                    totalMasuk += masuk;
                    totalKeluar += keluar;
                });
                const saldo = totalMasuk - totalKeluar;

                const cardHeader = document.createElement('div');
                cardHeader.className = `uangkas-period-header ${headerCollapsedClass}`;
                cardHeader.setAttribute('data-bs-toggle', 'collapse');
                cardHeader.setAttribute('data-bs-target', `#${collapseId}`);
                cardHeader.setAttribute('aria-expanded', ariaExpanded);
                cardHeader.setAttribute('aria-controls', collapseId);
                
                cardHeader.innerHTML = `
                    <div class="uangkas-period-title">
                        <div class="uangkas-period-icon"><i class="bi bi-calendar-event"></i></div>
                        <span>${periode}</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="uangkas-period-saldo me-3">
                            Saldo: Rp ${saldo.toLocaleString('id-ID')}
                        </div>
                        <i class="bi bi-chevron-down chevron-icon"></i>
                    </div>
                `;

                const collapseDiv = document.createElement('div');
                collapseDiv.id = collapseId;
                collapseDiv.className = `collapse ${bodyShowClass}`;
                
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-responsive'; 
                
                const table = document.createElement('table');
                table.className = 'table table-hover align-middle';

                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Tanggal</th>
                        <th style="min-width: 200px;">Keterangan</th>
                        <th class="text-end">Masuk</th>
                        <th class="text-end">Keluar</th>
                        <th class="text-end">Aksi</th>
                    </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                groupRows.forEach(row => {
                    const tr = document.createElement('tr');
                    const displayDate = formatDateDisplay(row[keyTanggal]);
                    
                    tr.innerHTML = `
                        <td class="fw-bold text-secondary">${displayDate}</td>
                        <td>${row[keyKet] || ''}</td>
                        <td class="text-end text-success fw-semibold">${row[keyMasuk] ? parseInt(row[keyMasuk]).toLocaleString('id-ID') : '-'}</td>
                        <td class="text-end text-danger fw-semibold">${row[keyKeluar] ? parseInt(row[keyKeluar]).toLocaleString('id-ID') : '-'}</td>
                        <td class="text-end pe-3">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-warning" onclick="openUpdateModal(${row._row}, ${JSON.stringify(row).replace(/"/g, '&quot;')})" title="Edit">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal(${row._row})" title="Hapus">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                tableWrapper.appendChild(table);
                collapseDiv.appendChild(tableWrapper);
                
                card.appendChild(cardHeader);
                card.appendChild(collapseDiv);
                container.appendChild(card);
            });
        }

        function renderEmptyState(tbody) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = "100%";
            td.className = "text-center text-muted py-4";
            td.textContent = "Tidak ada data.";
            tr.appendChild(td);
            tbody.appendChild(tr);
        }
        
        // --- MODAL HANDLERS ---
        function openCreateModal() {
            currentAction = 'create';
            document.getElementById('formModalLabel').innerText = `Tambah Data Baru ke ${currentSheet}`;
            
            if (currentSheet === 'IURAN BULANAN' || currentSheet === 'JADWAL RONDA') {
                generateSimplifiedFormFields();
            } else if (currentSheet === 'UANG KAS') {
                generateUangKasFormFields(); 
            } else {
                generateFormFields();
            }
            
            new bootstrap.Modal(document.getElementById('formModal')).show();
        }

        function openUpdateModal(rowNumber, rowData) {
            currentAction = 'update';
            currentRowNumber = rowNumber;
            document.getElementById('formModalLabel').innerText = `Edit Data di ${currentSheet}`;
            
            if (currentSheet === 'UANG KAS') {
                generateUangKasFormFields(rowData); 
            } else if (currentSheet === 'IURAN BULANAN' || currentSheet === 'JADWAL RONDA') {
                generateSimplifiedFormFields();
            } else {
                generateFormFields(rowData);
            }
            
            new bootstrap.Modal(document.getElementById('formModal')).show();
        }
        
        function openDeleteModal(rowNumber) {
            currentRowNumber = rowNumber;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        // --- FORM & CRUD ACTIONS ---
        function generateFormFields(data = {}) {
            const formBody = document.getElementById('formModalBody');
            formBody.innerHTML = '';

            if (currentHeaders.length === 0) {
                formBody.innerHTML = '<p class="text-muted">Tidak ada kolom untuk diisi.</p>';
                return;
            }

            currentHeaders.forEach(header => {
                const formGroup = document.createElement('div');
                formGroup.className = 'mb-3';
                
                const label = document.createElement('label');
                label.htmlFor = `input-${header}`;
                label.className = 'form-label';
                label.textContent = header;
                
                if (typeof data[header] === 'boolean') {
                    formGroup.className = 'mb-3 form-check';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'form-check-input';
                    input.id = `input-${header}`;
                    input.name = header;
                    input.checked = data[header];
                    formGroup.appendChild(input);
                    formGroup.appendChild(label);
                } else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.id = `input-${header}`;
                    input.name = header;
                    input.value = (data[header] !== undefined && data[header] !== null) ? data[header] : '';
                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                }
                formBody.appendChild(formGroup);
            });
        }

        function generateSimplifiedFormFields() {
            const formBody = document.getElementById('formModalBody');
            formBody.innerHTML = '';

            if (currentHeaders.length === 0) {
                formBody.innerHTML = '<p class="text-muted">Tidak ada kolom untuk diisi.</p>';
                return;
            }

            const header = currentHeaders[0];
            const formGroup = document.createElement('div');
            formGroup.className = 'mb-3';
            
            const label = document.createElement('label');
            label.htmlFor = `input-${header}`;
            label.className = 'form-label';
            label.textContent = header;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.id = `input-${header}`;
            input.name = header;
            input.value = '';
            input.required = true;
            
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            formBody.appendChild(formGroup);

            const infoDiv = document.createElement('div');
            infoDiv.className = 'alert alert-info bg-light border-0 text-secondary';
            infoDiv.innerHTML = `<i class="bi bi-info-circle me-1"></i> Kolom lainnya akan otomatis diisi.`;
            formBody.appendChild(infoDiv);
        }

        function generateUangKasFormFields(data = null) {
            const formBody = document.getElementById('formModalBody');
            formBody.innerHTML = '';

            if (currentHeaders.length === 0) {
                formBody.innerHTML = '<p class="text-muted">Tidak ada kolom untuk diisi.</p>';
                return;
            }

            let initialDate = new Date();
            let initialKet = '';
            let initialJenis = 'pemasukkan'; 
            let initialJumlah = '';

            if (data) {
                const keyTanggal = currentHeaders.find(h => h.toLowerCase() === 'tanggal');
                const keyKet = currentHeaders.find(h => h.toLowerCase().includes('keterangan'));
                const keyMasuk = currentHeaders.find(h => h.toLowerCase().includes('pemasukkan'));
                const keyKeluar = currentHeaders.find(h => h.toLowerCase().includes('pengeluaran'));

                if (data[keyTanggal]) initialDate = new Date(data[keyTanggal]);
                if (data[keyKet]) initialKet = data[keyKet];
                
                const valMasuk = (data[keyMasuk] !== undefined && data[keyMasuk] !== null) ? parseFloat(data[keyMasuk]) : 0;
                const valKeluar = (data[keyKeluar] !== undefined && data[keyKeluar] !== null) ? parseFloat(data[keyKeluar]) : 0;

                if (valMasuk > 0) {
                    initialJenis = 'pemasukkan';
                    initialJumlah = valMasuk;
                } else if (valKeluar > 0) {
                    initialJenis = 'pengeluaran';
                    initialJumlah = valKeluar;
                }
            }

            const formattedDate = `${initialDate.getFullYear()}-${String(initialDate.getMonth() + 1).padStart(2, '0')}-${String(initialDate.getDate()).padStart(2, '0')}`;

            const dateGroup = document.createElement('div');
            dateGroup.className = 'mb-3';
            const dateLabel = document.createElement('label');
            dateLabel.htmlFor = 'input-tanggal';
            dateLabel.className = 'form-label';
            dateLabel.textContent = 'Tanggal Transaksi';
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'form-control';
            dateInput.id = 'input-tanggal';
            dateInput.name = 'tanggal';
            dateInput.value = formattedDate;
            dateInput.required = true;
            dateGroup.appendChild(dateLabel);
            dateGroup.appendChild(dateInput);
            formBody.appendChild(dateGroup);

            const descHeader = currentHeaders.find(h => h.toLowerCase() === 'keterangan' || h.toLowerCase() === 'deskripsi') || 'Keterangan';
            const descGroup = document.createElement('div');
            descGroup.className = 'mb-3';
            const descLabel = document.createElement('label');
            descLabel.htmlFor = 'input-keterangan';
            descLabel.className = 'form-label';
            descLabel.textContent = descHeader;
            const descInput = document.createElement('input');
            descInput.type = 'text';
            descInput.className = 'form-control';
            descInput.id = 'input-keterangan';
            descInput.name = 'keterangan';
            descInput.value = initialKet;
            descInput.placeholder = "Contoh: Iuran Kebersihan";
            descInput.required = true;
            descGroup.appendChild(descLabel);
            descGroup.appendChild(descInput);
            formBody.appendChild(descGroup);

            const typeGroup = document.createElement('div');
            typeGroup.className = 'mb-3';
            const typeLabel = document.createElement('label');
            typeLabel.htmlFor = 'input-jenis';
            typeLabel.className = 'form-label';
            typeLabel.textContent = 'Jenis Transaksi';
            const typeSelect = document.createElement('select');
            typeSelect.className = 'form-select';
            typeSelect.id = 'input-jenis';
            typeSelect.name = 'jenis';
            
            const pemasukanOption = document.createElement('option');
            pemasukanOption.value = 'pemasukkan';
            pemasukanOption.textContent = 'Pemasukkan (Uang Masuk)';
            if (initialJenis === 'pemasukkan') pemasukanOption.selected = true;
            
            const pengeluaranOption = document.createElement('option');
            pengeluaranOption.value = 'pengeluaran';
            pengeluaranOption.textContent = 'Pengeluaran (Uang Keluar)';
            if (initialJenis === 'pengeluaran') pengeluaranOption.selected = true;

            typeSelect.appendChild(pemasukanOption);
            typeSelect.appendChild(pengeluaranOption);
            typeGroup.appendChild(typeLabel);
            typeGroup.appendChild(typeSelect);
            formBody.appendChild(typeGroup);

            const amountGroup = document.createElement('div');
            amountGroup.className = 'mb-3';
            const amountLabel = document.createElement('label');
            amountLabel.htmlFor = 'input-jumlah';
            amountLabel.className = 'form-label';
            amountLabel.textContent = 'Nominal (Rp)';
            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.className = 'form-control form-control-lg';
            amountInput.id = 'input-jumlah';
            amountInput.name = 'jumlah';
            amountInput.value = initialJumlah;
            amountInput.placeholder = "0";
            amountInput.required = true;
            amountInput.min = '0';
            amountGroup.appendChild(amountLabel);
            amountGroup.appendChild(amountInput);
            formBody.appendChild(amountGroup);
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            let values = [];

            if (currentAction === 'create') {
                if (currentSheet === 'IURAN BULANAN' || currentSheet === 'JADWAL RONDA') {
                    const firstColumnValue = formData.get(currentHeaders[0]) || '';
                    values = [firstColumnValue];
                    for (let i =1; i < currentHeaders.length; i++) {
                        if (currentSheet === 'JADWAL RONDA' && String(currentHeaders[i]).toLowerCase() === 'terakhir ronda') {
                            values.push('');
                        } else {
                            values.push(false);
                        }
                    }
                } 
                else if (currentSheet === 'UANG KAS') {
                    const jenis = formData.get('jenis') || '';
                    const jumlah = formData.get('jumlah') || '0';
                    const tanggalValue = formData.get('tanggal') || '';
                    const keteranganValue = formData.get('keterangan') || '';
                    
                    const formatBulanTahun = (dateString) => {
                        if (!dateString) return '';
                        const date = new Date(dateString);
                        return date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' });
                    };

                    const pemasukkanValue = (jenis === 'pemasukkan') ? jumlah : '0';
                    const pengeluaranValue = (jenis === 'pengeluaran') ? jumlah : '0';

                    values = [
                        formatBulanTahun(tanggalValue),
                        tanggalValue,
                        keteranganValue,
                        pemasukkanValue,
                        pengeluaranValue
                    ];
                } 
                else {
                    values = currentHeaders.map(header => {
                        const val = formData.get(header);
                        if (typeof form.elements[`input-${header}`]?.type === 'checkbox') {
                            return val === 'on';
                        }
                        return val || '';
                    });
                }
            } else {
                values = currentHeaders.map(header => {
                    const val = formData.get(header);
                    if (typeof form.elements[`input-${header}`]?.type === 'checkbox') {
                        return val === 'on';
                    }
                    return val || '';
                });
            }
            
            showLoader(true);
            let payload = {
                sheet: currentSheet,
                action: currentAction,
                values: values
            };
            if (currentAction === 'update') {
                payload.row = currentRowNumber;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                showAlert(`Data berhasil ${currentAction === 'create' ? 'ditambahkan' : 'diperbarui'}!`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
                form.reset();
                loadData(currentSheet);

            } catch (error) {
                showAlert('Terjadi kesalahan: ' + error.message, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function confirmDelete() {
            showLoader(true);
            const payload = {
                sheet: currentSheet,
                action: 'delete',
                row: currentRowNumber
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }
                
                showAlert('Data berhasil dihapus!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                loadData(currentSheet);

            } catch (error) {
                showAlert('Terjadi kesalahan: ' + error.message, 'danger');
            } finally {
                showLoader(false);
            }
        }

        async function toggleBoolean(rowNumber, columnName, iconElement) {
            const isCurrentlyTrue = iconElement.classList.contains('bi-check-circle-fill');
            const newValue = !isCurrentlyTrue;

            const originalClasses = iconElement.className;
            const originalTitle = iconElement.title;

            if (newValue) {
                iconElement.className = 'clickable-icon bi bi-check-circle-fill text-success fs-5';
                iconElement.title = 'Selesai. Klik untuk ubah.';
            } else {
                iconElement.className = 'clickable-icon bi bi-circle text-muted fs-5';
                iconElement.title = 'Belum Selesai. Klik untuk ubah.';
            }
            
            iconElement.classList.add('opacity-50');

            const rowIndex = tableData.findIndex(row => row._row === rowNumber);
            if (rowIndex !== -1) {
                tableData[rowIndex][columnName] = newValue;
            }

            const payload = {
                sheet: currentSheet,
                action: 'updateCell',
                row: rowNumber,
                column: columnName,
                value: newValue
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                showAlert(result.message || 'Status berhasil diperbarui!', 'success');

            } catch (error) {
                showAlert('Gagal memperbarui status: ' + error.message, 'danger');
                iconElement.className = originalClasses;
                iconElement.title = originalTitle;
                
                if (rowIndex !== -1) {
                    tableData[rowIndex][columnName] = isCurrentlyTrue;
                }
            } finally {
                iconElement.classList.remove('opacity-50');
            }
        }

        // --- UTILITIES ---
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

    </script>
</body>
</html>
